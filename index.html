<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="En Fouple">
    <title>En Fouple - Application priv√©e</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíú</text></svg>">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap');
        * { -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; overflow-x: hidden; font-family: 'Work Sans', sans-serif; }
        .cormorant { font-family: 'Cormorant Garamond', serif; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-30px); } }
        @keyframes glow { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
        .slide-in { animation: slideIn 0.5s ease-out forwards; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .float-animation { animation: float 8s ease-in-out infinite; }
        .glow-orb { animation: glow 4s ease-in-out infinite; }
        .grain { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); }
        .message-actions { opacity: 0; transition: opacity 0.2s; }
        .message-container:hover .message-actions { opacity: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // CONFIGURATION SUPABASE
        const SUPABASE_URL = "https://kuqctucmvebpenqucquk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1cWN0dWNtdmVicGVucXVjcXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4NjU0ODQsImV4cCI6MjA1NDQ0MTQ4NH0.GVxDR-izhm3MqOM0eICuvNQIwAffVeUmTVZHz7dlZtA";
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // IC√îNES SVG
        const Heart = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>;
        const Lock = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
        const Send = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>;
        const Bell = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>;
        const Plus = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>;
        const X = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>;
        const Edit = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const Trash = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const Reply = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>;
        const ChevronRight = ({ className, strokeWidth = 2 }) => <svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>;

        const CATS = [
            { id: 'memorables', name: 'M√©morables', emoji: '‚ú¶', gradient: 'from-purple-900 to-pink-900', bgGradient: 'from-purple-950/20 to-pink-950/20', shadow: 'shadow-purple-900/20' },
            { id: 'questions', name: 'Questions intimes', emoji: '‚óÜ', gradient: 'from-violet-900 to-purple-900', bgGradient: 'from-violet-950/20 to-purple-950/20', shadow: 'shadow-violet-900/20' },
            { id: 'chemin', name: 'Notre chemin', emoji: '‚óè', gradient: 'from-blue-950 to-indigo-900', bgGradient: 'from-blue-950/20 to-indigo-950/20', shadow: 'shadow-blue-900/20' },
            { id: 'projets', name: 'Projets & Envies', emoji: '‚òÖ', gradient: 'from-red-950 to-orange-900', bgGradient: 'from-red-950/20 to-orange-950/20', shadow: 'shadow-red-900/20' },
            { id: 'scenarios', name: 'Nos sc√©narios', emoji: '‚óá', gradient: 'from-teal-950 to-emerald-900', bgGradient: 'from-teal-950/20 to-emerald-950/20', shadow: 'shadow-teal-900/20' },
            { id: 'culture', name: 'Culture √† deux', emoji: '‚óà', gradient: 'from-amber-950 to-yellow-900', bgGradient: 'from-amber-950/20 to-yellow-950/20', shadow: 'shadow-amber-900/20' }
        ];

        function App() {
            const [auth, setAuth] = useState(false);
            const [pwd, setPwd] = useState('');
            const [msgs, setMsgs] = useState([]);
            const [cat, setCat] = useState(null);
            const [text, setText] = useState('');
            const [comp, setComp] = useState(false);
            const [editId, setEditId] = useState(null);
            const [editTxt, setEditTxt] = useState('');
            const [replyTo, setReplyTo] = useState(null);
            const [replyTxt, setReplyTxt] = useState('');
            const [readIds, setReadIds] = useState([]);
            const [notifs, setNotifs] = useState([]);

            const [devId] = useState(() => {
                let id = localStorage.getItem("ef-dev");
                if (!id) {
                    id = "dev-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("ef-dev", id);
                }
                return id;
            });

            const loadMsgs = async () => {
                const { data, error } = await db
                    .from("messages")
                    .select("*")
                    .order("timestamp", { ascending: false });

                if (!error) {
                    setMsgs(data);
                    const stored = localStorage.getItem('ef-read');
                    const read = stored ? JSON.parse(stored) : [];
                    const unread = data.filter(m => m.device_id !== devId && !read.includes(m.id));
                    setNotifs(unread);
                }
            };

            useEffect(() => {
                if (!auth) return;
                loadMsgs();

                const sub = db.channel("msgs")
                    .on("postgres_changes", { event: "*", schema: "public", table: "messages" }, loadMsgs)
                    .subscribe();

                return () => sub.unsubscribe();
            }, [auth]);

            useEffect(() => {
                const stored = localStorage.getItem('ef-read');
                if (stored) setReadIds(JSON.parse(stored));
            }, []);

            const login = async () => {
                if (pwd.length < 3) return alert("Min 3 caract√®res");
                const { data } = await db.from("config").select("*").eq("key", "password").single();

                if (!data) {
                    await db.from("config").insert({ key: "password", value: pwd });
                    setAuth(true);
                    alert("‚úÖ Mot de passe cr√©√© !");
                    return;
                }

                if (data.value === pwd) setAuth(true);
                else alert("‚ùå Mot de passe incorrect");
            };

            const send = async () => {
                if (!text.trim() || !cat) return;

                const { error } = await db.from("messages").insert({
                    category: cat,
                    text,
                    timestamp: Date.now(),
                    device_id: devId,
                    replies: [],
                    edited: false
                });

                if (error) {
                    alert("Erreur : " + error.message);
                    return;
                }

                setText('');
                setComp(false);
                setCat(null);
            };

            const del = async (id) => {
                if (confirm("Supprimer ce message ?")) {
                    await db.from("messages").delete().eq("id", id);
                }
            };

            const edit = async (id, newText) => {
                await db.from("messages").update({ text: newText, edited: true }).eq("id", id);
                setEditId(null);
                setEditTxt('');
            };

            const sendReply = async (msgId) => {
                if (!replyTxt.trim()) return;
                const msg = msgs.find(m => m.id === msgId);
                const replies = msg.replies || [];
                replies.push({
                    id: Date.now(),
                    text: replyTxt,
                    timestamp: Date.now(),
                    device_id: devId
                });
                await db.from("messages").update({ replies }).eq("id", msgId);
                setReplyTo(null);
                setReplyTxt('');
            };

            const delReply = async (msgId, rId) => {
                if (confirm("Supprimer cette r√©ponse ?")) {
                    const msg = msgs.find(m => m.id === msgId);
                    const replies = (msg.replies || []).filter(r => r.id !== rId);
                    await db.from("messages").update({ replies }).eq("id", msgId);
                }
            };

            const markRead = (catId) => {
                const catMsgs = msgs.filter(m => m.category === catId);
                const ids = catMsgs.map(m => m.id);
                const rIds = catMsgs.flatMap(m => (m.replies || []).map(r => r.id));
                const newRead = [...new Set([...readIds, ...ids, ...rIds])];
                setReadIds(newRead);
                localStorage.setItem('ef-read', JSON.stringify(newRead));
            };

            const clearNotifs = () => {
                const all = msgs.flatMap(m => [m.id, ...(m.replies || []).map(r => r.id)]);
                setReadIds(all);
                localStorage.setItem('ef-read', JSON.stringify(all));
                setNotifs([]);
            };

            const getCatMsgs = (c) => msgs.filter(m => m.category === c).sort((a, b) => b.timestamp - a.timestamp);

            const getUnread = (c) => {
                const cm = getCatMsgs(c);
                const u = cm.filter(m => m.device_id !== devId && !readIds.includes(m.id)).length;
                const ur = cm.reduce((cnt, m) => cnt + (m.replies || []).filter(r => r.device_id !== devId && !readIds.includes(r.id)).length, 0);
                return u + ur;
            };

            const fmtDate = (ts) => {
                const d = new Date(ts);
                const now = new Date();
                const diff = Math.floor((now - d) / 86400000);
                if (diff === 0) return "Aujourd'hui";
                if (diff === 1) return "Hier";
                if (diff < 7) return `Il y a ${diff} jours`;
                return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
            };

            const isMine = (id) => id === devId;

            if (!auth) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950 flex items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute inset-0 overflow-hidden">
                            <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-600/20 rounded-full blur-3xl glow-orb"></div>
                            <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-pink-600/20 rounded-full blur-3xl glow-orb" style={{animationDelay:'2s'}}></div>
                        </div>
                        <div className="grain absolute inset-0"></div>
                        <div className="max-w-md w-full relative z-10 fade-in">
                            <div className="text-center mb-10">
                                <div className="inline-block mb-6 float-animation">
                                    <div className="relative">
                                        <Heart className="w-20 h-20 text-purple-300" strokeWidth={1.5} />
                                        <div className="absolute inset-0 bg-purple-500/20 blur-xl rounded-full"></div>
                                    </div>
                                </div>
                                <h1 className="text-6xl font-light text-white cormorant mb-3 tracking-wide">En Fouple</h1>
                                <p className="text-slate-400 text-lg font-light tracking-wide">Un sanctuaire pour nous deux</p>
                            </div>
                            <div className="bg-slate-900/50 backdrop-blur-xl rounded-2xl shadow-2xl p-8 border border-slate-800">
                                <div className="mb-6">
                                    <label className="flex items-center text-slate-300 mb-3 font-light tracking-wide">
                                        <Lock className="w-5 h-5 mr-2 text-purple-400" strokeWidth={1.5} />
                                        Mot de passe partag√©
                                    </label>
                                    <input type="password" value={pwd} onChange={e => setPwd(e.target.value)} onKeyPress={e => e.key === 'Enter' && login()} className="w-full px-4 py-3 bg-slate-950/50 border border-slate-800 rounded-lg focus:outline-none focus:border-purple-600 transition-colors text-white placeholder-slate-600" placeholder="Minimum 3 caract√®res" />
                                </div>
                                <button onClick={login} className="w-full bg-gradient-to-r from-purple-900 to-purple-700 text-white py-3 rounded-lg font-medium hover:from-purple-800 hover:to-purple-600 transition-all shadow-lg shadow-purple-900/30">
                                    Acc√©der √† l'espace
                                </button>
                                <p className="text-sm text-slate-500 mt-6 text-center font-light flex items-center justify-center gap-2">
                                    <Lock className="w-3 h-3" strokeWidth={1.5} />
                                    Totalement priv√© et s√©curis√©
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 relative">
                    <div className="grain absolute inset-0 pointer-events-none"></div>

                    <div className="bg-slate-900/80 backdrop-blur-xl shadow-lg border-b border-slate-800 sticky top-0 z-10">
                        <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <Heart className="w-7 h-7 text-purple-400" strokeWidth={1.5} />
                                <h1 className="text-2xl font-light text-white cormorant tracking-wide">En Fouple</h1>
                            </div>
                            <div className="flex items-center gap-4">
                                {notifs.length > 0 && (
                                    <button onClick={clearNotifs} className="relative">
                                        <Bell className="w-6 h-6 text-purple-400" strokeWidth={1.5} />
                                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-semibold">{notifs.length}</span>
                                    </button>
                                )}
                                <button onClick={() => setComp(true)} className="bg-gradient-to-r from-purple-900 to-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-purple-800 hover:to-purple-600 transition-all shadow-lg shadow-purple-900/30">
                                    <Plus className="w-5 h-5" strokeWidth={1.5} />
                                    <span className="font-light">Nouveau</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {notifs.length > 0 && (
                        <div className="max-w-6xl mx-auto px-4 py-4">
                            <div className="bg-gradient-to-r from-purple-900/80 to-purple-800/80 backdrop-blur-sm text-white p-4 rounded-xl shadow-lg fade-in border border-purple-700/30">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <Bell className="w-5 h-5" strokeWidth={1.5} />
                                        <span className="font-light">{notifs.length} nouveau{notifs.length > 1 ? 'x' : ''} message{notifs.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <button onClick={clearNotifs} className="text-white/70 hover:text-white transition-colors">
                                        <X className="w-5 h-5" strokeWidth={1.5} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-6xl mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {CATS.map((c, i) => {
                                const cm = getCatMsgs(c.id);
                                const u = getUnread(c.id);
                                return (
                                    <div key={c.id} className={`slide-in bg-gradient-to-br ${c.bgGradient} backdrop-blur-sm rounded-2xl shadow-xl p-6 border border-slate-800 hover:border-slate-700 transition-all transform hover:-translate-y-1 cursor-pointer relative overflow-hidden group`} style={{animationDelay:`${i*.1}s`}} onClick={() => {setCat(c.id);setComp(false);markRead(c.id);}}>
                                        <div className={`absolute inset-0 bg-gradient-to-br ${c.gradient} opacity-0 group-hover:opacity-10 transition-opacity duration-300`}></div>
                                        <div className="relative z-10">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex items-center gap-4">
                                                    <div className={`text-3xl w-14 h-14 flex items-center justify-center bg-gradient-to-br ${c.gradient} rounded-xl ${c.shadow} shadow-xl`}>
                                                        <span className="text-white/90">{c.emoji}</span>
                                                    </div>
                                                    <div>
                                                        <h2 className="text-xl font-light text-white cormorant tracking-wide">{c.name}</h2>
                                                        <p className="text-sm text-slate-400 font-light">{cm.length} message{cm.length > 1 ? 's' : ''}</p>
                                                    </div>
                                                </div>
                                                {u > 0 && <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full font-semibold">{u}</span>}
                                            </div>
                                            {cm.length > 0 && (
                                                <div className="bg-slate-900/50 backdrop-blur-sm rounded-xl p-4 mt-4 border border-slate-800/50">
                                                    <p className="text-slate-300 line-clamp-2 mb-2 font-light">{cm[0].text}</p>
                                                    <p className="text-xs text-slate-500 font-light">{fmtDate(cm[0].timestamp)}</p>
                                                </div>
                                            )}
                                            <div className="flex items-center justify-end mt-4 text-slate-400 group-hover:text-slate-300 transition-colors">
                                                <span className="text-sm font-light">Voir tout</span>
                                                <ChevronRight className="w-4 h-4 ml-1" strokeWidth={1.5} />
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {comp && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-50 fade-in">
                            <div className="bg-slate-900 rounded-2xl shadow-2xl max-w-2xl w-full p-8 slide-in border border-slate-800 max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-6">
                                    <h2 className="text-2xl font-light text-white cormorant tracking-wide">Nouveau message</h2>
                                    <button onClick={() => {setComp(false);setText('');setCat(null);}} className="text-slate-400 hover:text-slate-200 transition-colors">
                                        <X className="w-6 h-6" strokeWidth={1.5} />
                                    </button>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-slate-300 font-light mb-3 tracking-wide">Choisir une rubrique</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {CATS.map(c => (
                                            <button key={c.id} onClick={() => setCat(c.id)} className={`p-4 rounded-xl border transition-all ${cat === c.id ? `border-transparent bg-gradient-to-br ${c.gradient} text-white shadow-lg ${c.shadow}` : 'border-slate-800 hover:border-slate-700 bg-slate-950/50'}`}>
                                                <div className="text-2xl mb-2">{c.emoji}</div>
                                                <div className={`text-sm font-light ${cat === c.id ? 'text-white' : 'text-slate-300'}`}>{c.name}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="mb-6">
                                    <label className="block text-slate-300 font-light mb-3 tracking-wide">Votre message</label>
                                    <textarea value={text} onChange={e => setText(e.target.value)} className="w-full h-40 px-4 py-3 bg-slate-950/50 border border-slate-800 rounded-xl focus:outline-none focus:border-purple-600 resize-none text-white placeholder-slate-600 font-light" placeholder="√âcrivez votre message..." />
                                </div>
                                <button onClick={send} disabled={!cat || !text.trim()} className="w-full bg-gradient-to-r from-purple-900 to-purple-700 text-white py-3 rounded-xl font-light hover:from-purple-800 hover:to-purple-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg shadow-purple-900/30">
                                    <Send className="w-5 h-5" strokeWidth={1.5} />
                                    Envoyer le message
                                </button>
                            </div>
                        </div>
                    )}

                    {cat && !comp && (() => {
                        const c = CATS.find(x => x.id === cat);
                        const cm = getCatMsgs(cat);
                        return (
                            <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-50 fade-in">
                                <div className="bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden slide-in border border-slate-800">
                                    <div className={`bg-gradient-to-r ${c.gradient} p-6 text-white relative overflow-hidden`}>
                                        <div className="flex items-center justify-between relative z-10">
                                            <div className="flex items-center gap-4">
                                                <div className="text-4xl w-16 h-16 flex items-center justify-center bg-white/10 backdrop-blur-sm rounded-xl">{c.emoji}</div>
                                                <div>
                                                    <h2 className="text-3xl font-light cormorant tracking-wide">{c.name}</h2>
                                                    <p className="text-white/70 font-light">{cm.length} message{cm.length > 1 ? 's' : ''}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => setCat(null)} className="text-white/70 hover:text-white transition-colors">
                                                <X className="w-6 h-6" strokeWidth={1.5} />
                                            </button>
                                        </div>
                                    </div>
                                    <div className="overflow-y-auto p-6 bg-slate-950" style={{maxHeight:'calc(90vh - 120px)'}}>
                                        {cm.length === 0 ? (
                                            <div className="text-center py-12 text-slate-500">
                                                <p className="text-lg font-light">Aucun message pour le moment</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-6">
                                                {cm.map((m, idx) => {
                                                    const unread = !readIds.includes(m.id);
                                                    const mine = isMine(m.device_id);
                                                    const bg = mine ? c.bgGradient : 'from-slate-900/40 to-slate-800/40';
                                                    const border = unread ? 'border-purple-500' : (mine ? 'border-purple-900/30' : 'border-cyan-900/30');
                                                    return (
                                                        <div key={m.id} className="space-y-3">
                                                            <div className={`message-container bg-gradient-to-br ${bg} backdrop-blur-sm rounded-xl p-5 border ${border} slide-in ${c.shadow}`}>
                                                                {editId === m.id ? (
                                                                    <div className="space-y-3">
                                                                        <textarea value={editTxt} onChange={e => setEditTxt(e.target.value)} className="w-full h-32 px-4 py-3 bg-slate-950/50 border border-slate-800 rounded-xl focus:outline-none focus:border-purple-600 resize-none text-white font-light" />
                                                                        <div className="flex gap-2">
                                                                            <button onClick={() => edit(m.id, editTxt)} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-light hover:bg-purple-700 transition-colors">Enregistrer</button>
                                                                            <button onClick={() => {setEditId(null);setEditTxt('');}} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm font-light hover:bg-slate-600 transition-colors">Annuler</button>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <>
                                                                        <div className="flex items-start justify-between gap-3">
                                                                            <p className="text-slate-200 whitespace-pre-wrap font-light leading-relaxed flex-1">{m.text}</p>
                                                                            <div className="message-actions flex gap-2">
                                                                                <button onClick={() => {setEditId(m.id);setEditTxt(m.text);}} className="text-slate-500 hover:text-purple-400 transition-colors"><Edit className="w-4 h-4" strokeWidth={1.5} /></button>
                                                                                <button onClick={() => del(m.id)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash className="w-4 h-4" strokeWidth={1.5} /></button>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center justify-between text-xs text-slate-500 mt-3">
                                                                            <div className="flex items-center gap-3">
                                                                                <span className="font-light">{fmtDate(m.timestamp)}</span>
                                                                                {m.edited && <span className="text-slate-600 italic">modifi√©</span>}
                                                                                {unread && <span className="bg-purple-500 text-white px-2 py-0.5 rounded-full text-xs">Nouveau</span>}
                                                                            </div>
                                                                            <button onClick={() => setReplyTo(m.id)} className="flex items-center gap-1 text-slate-400 hover:text-purple-400 transition-colors">
                                                                                <Reply className="w-4 h-4" strokeWidth={1.5} />
                                                                                <span className="font-light">R√©pondre</span>
                                                                            </button>
                                                                        </div>
                                                                    </>
                                                                )}
                                                            </div>
                                                            {m.replies && m.replies.length > 0 && (
                                                                <div className="ml-8 space-y-2">
                                                                    {m.replies.map(r => {
                                                                        const runread = !readIds.includes(r.id);
                                                                        const rmine = isMine(r.device_id);
                                                                        const rbg = rmine ? 'bg-slate-900/60' : 'bg-slate-800/60';
                                                                        const rborder = runread ? 'border-purple-500/50' : (rmine ? 'border-purple-900/20' : 'border-cyan-900/20');
                                                                        return (
                                                                            <div key={r.id} className={`message-container ${rbg} rounded-lg p-4 border ${rborder}`}>
                                                                                <div className="flex items-start justify-between gap-3">
                                                                                    <p className="text-slate-300 text-sm font-light leading-relaxed flex-1">{r.text}</p>
                                                                                    <button onClick={() => delReply(m.id, r.id)} className="message-actions text-slate-600 hover:text-red-400 transition-colors"><Trash className="w-3 h-3" strokeWidth={1.5} /></button>
                                                                                </div>
                                                                                <div className="flex items-center gap-2 text-xs text-slate-600 mt-2">
                                                                                    <span className="font-light">{fmtDate(r.timestamp)}</span>
                                                                                    {runread && <span className="bg-purple-500/70 text-white px-2 py-0.5 rounded-full text-xs">Nouveau</span>}
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            )}
                                                            {replyTo === m.id && (
                                                                <div className="ml-8 bg-slate-900/50 rounded-lg p-4 border border-slate-800">
                                                                    <textarea value={replyTxt} onChange={e => setReplyTxt(e.target.value)} placeholder="Votre r√©ponse..." className="w-full h-24 px-3 py-2 bg-slate-950/50 border border-slate-800 rounded-lg focus:outline-none focus:border-purple-600 resize-none text-white text-sm font-light placeholder-slate-600" />
                                                                    <div className="flex gap-2 mt-3">
                                                                        <button onClick={() => sendReply(m.id)} disabled={!replyTxt.trim()} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-light hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Envoyer</button>
                                                                        <button onClick={() => {setReplyTo(null);setReplyTxt('');}} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm font-light hover:bg-slate-600 transition-colors">Annuler</button>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>
