
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>En Fouple ðŸ’œ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#0f0f14,#1a1a2e);
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const {useState,useEffect}=React;

/* ðŸ”‘ REMPLACE PAR TES CLÃ‰S */
const SUPABASE_URL="https://TON-PROJET.supabase.co";
const SUPABASE_KEY="TA-ANON-KEY";

const {createClient}=supabase;
const db=createClient(SUPABASE_URL,SUPABASE_KEY);

/* CATÃ‰GORIES */
const CATS=[
 {id:"memorables",name:"MÃ©morables"},
 {id:"questions",name:"Questions intimes"},
 {id:"chemin",name:"Notre chemin"},
 {id:"projets",name:"Projets & Envies"}
];

function App(){

const [auth,setAuth]=useState(false);
const [pwd,setPwd]=useState("");
const [msgs,setMsgs]=useState([]);
const [cat,setCat]=useState("memorables");
const [text,setText]=useState("");
const [reply,setReply]=useState({});
const [devId]=useState(()=>{
 let id=localStorage.getItem("ef-dev");
 if(!id){
   id="dev-"+crypto.randomUUID();
   localStorage.setItem("ef-dev",id);
 }
 return id;
});

/* LOAD */
const loadMsgs=async()=>{
 const {data}=await db
  .from("messages")
  .select("*")
  .order("timestamp",{ascending:false});
 if(data) setMsgs(data);
};

/* REALTIME */
useEffect(()=>{
 loadMsgs();
 const sub=db.channel("msgs")
  .on("postgres_changes",
   {event:"*",schema:"public",table:"messages"},
   loadMsgs)
  .subscribe();
 return()=>sub.unsubscribe();
},[]);

/* LOGIN */
const login=async()=>{
 const {data}=await db
  .from("config")
  .select("*")
  .eq("key","password")
  .single();

 if(!data){
  await db.from("config")
   .insert({key:"password",value:pwd});
  setAuth(true);
  return;
 }

 if(data.value===pwd) setAuth(true);
 else alert("Mot de passe incorrect");
};

/* SEND */
const send=async()=>{
 if(!text.trim()) return;

 const {error}=await db
  .from("messages")
  .insert({
   category:cat,
   text,
   timestamp:Date.now(),
   device_id:devId,
   replies:[],
   edited:false
  });

 if(error) alert(error.message);
 else setText("");
};

/* DELETE */
const del=async(id)=>{
 await db.from("messages").delete().eq("id",id);
};

/* REPLY */
const sendReply=async(msg)=>{
 if(!reply[msg.id]) return;

 const replies=[...(msg.replies||[])];
 replies.push({
  id:Date.now(),
  text:reply[msg.id],
  device_id:devId,
  timestamp:Date.now()
 });

 await db.from("messages")
  .update({replies})
  .eq("id",msg.id);

 setReply({...reply,[msg.id]:""});
};

/* LOGIN UI */
if(!auth){
 return(
  <div className="min-h-screen flex items-center justify-center text-white">
   <div className="bg-black/40 p-8 rounded-xl backdrop-blur">
    <h2 className="text-2xl mb-4">Mot de passe partagÃ©</h2>
    <input
     type="password"
     className="text-black p-2 rounded w-full"
     value={pwd}
     onChange={e=>setPwd(e.target.value)}
    />
    <button
     onClick={login}
     className="mt-4 bg-purple-600 px-4 py-2 rounded">
     Entrer
    </button>
   </div>
  </div>
 );
}

/* APP UI */
return(
<div className="max-w-4xl mx-auto p-6 text-white">

<h1 className="text-4xl mb-6">En Fouple ðŸ’œ</h1>

{/* NEW MSG */}
<div className="bg-white/5 p-4 rounded-xl mb-6">
<select
 className="text-black p-2 rounded w-full mb-3"
 value={cat}
 onChange={e=>setCat(e.target.value)}
>
 {CATS.map(c=>
  <option key={c.id} value={c.id}>{c.name}</option>
 )}
</select>

<textarea
 className="text-black p-2 rounded w-full mb-3"
 rows="4"
 placeholder="Ã‰crire un messageâ€¦"
 value={text}
 onChange={e=>setText(e.target.value)}
/>

<button
 onClick={send}
 className="bg-purple-600 px-4 py-2 rounded">
 Envoyer
</button>
</div>

{/* MSGS */}
{msgs
 .filter(m=>m.category===cat)
 .map(m=>(

<div key={m.id}
 className="bg-white/5 p-4 rounded-xl mb-4">

<div className="mb-2">{m.text}</div>

<small className="opacity-60">
 {new Date(m.timestamp).toLocaleString()}
</small>

<div className="mt-3 flex gap-2">
<button
 onClick={()=>del(m.id)}
 className="bg-red-600 px-2 py-1 rounded text-sm">
 Supprimer
</button>
</div>

{/* REPLIES */}
<div className="mt-4 ml-4 space-y-2">
 {(m.replies||[]).map(r=>
  <div key={r.id}
   className="bg-black/40 p-2 rounded">
   {r.text}
  </div>
 )}
</div>

{/* ADD REPLY */}
<textarea
 className="text-black p-2 rounded w-full mt-3"
 rows="2"
 placeholder="RÃ©pondreâ€¦"
 value={reply[m.id]||""}
 onChange={e=>
  setReply({...reply,[m.id]:e.target.value})
 }
/>

<button
 onClick={()=>sendReply(m)}
 className="bg-indigo-600 px-3 py-1 rounded mt-2 text-sm">
 RÃ©pondre
</button>

</div>

))}

</div>
);
}

ReactDOM
.createRoot(document.getElementById("root"))
.render(<App/>);

</script>
</body>
</html>
